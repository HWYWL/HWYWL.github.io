<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>MySQL史上最全SQL优化方案 | 一叶秋枫</title><meta name="description" content="MySQL史上最全SQL优化方案。"><meta name="keywords" content="MySQL"><meta name="author" content="一叶秋枫"><meta name="copyright" content="一叶秋枫"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://hm.baidu.com"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="MySQL史上最全SQL优化方案"><meta name="twitter:description" content="MySQL史上最全SQL优化方案。"><meta name="twitter:image" content="https://s1.ax1x.com/2020/03/16/8J7MAx.png"><meta property="og:type" content="article"><meta property="og:title" content="MySQL史上最全SQL优化方案"><meta property="og:url" content="https://hwy.ac.cn/2019/01/30/MySQL%E5%8F%B2%E4%B8%8A%E6%9C%80%E5%85%A8SQL%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88/"><meta property="og:site_name" content="一叶秋枫"><meta property="og:description" content="MySQL史上最全SQL优化方案。"><meta property="og:image" content="https://s1.ax1x.com/2020/03/16/8J7MAx.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://hwy.ac.cn/2019/01/30/MySQL%E5%8F%B2%E4%B8%8A%E6%9C%80%E5%85%A8SQL%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88/"><link rel="prev" title="nginx之proxy_pass代理后端https请求完全拆解" href="https://hwy.ac.cn/2019/02/18/nginx%E4%B9%8Bproxy_pass%E4%BB%A3%E7%90%86%E5%90%8E%E7%AB%AFhttps%E8%AF%B7%E6%B1%82%E5%AE%8C%E5%85%A8%E6%8B%86%E8%A7%A3/"><link rel="next" title="go-fastdfs 小巧灵活的文件系统" href="https://hwy.ac.cn/2019/01/29/go-fastdfs%20%E5%B0%8F%E5%B7%A7%E7%81%B5%E6%B4%BB%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?91b2d9755d63bbc10c5c757667aa0fcf";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://hwy.ac.cn/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">一叶秋枫</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-picture-o"></i><span> 相册</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-heartbeat" aria-hidden="true"></i><span> 娱乐</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">110</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">56</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">21</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-picture-o"></i><span> 相册</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-heartbeat" aria-hidden="true"></i><span> 娱乐</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#史上最全SQL优化方案"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">史上最全SQL优化方案</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#1、优化的哲学"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">1、优化的哲学</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#a优化可能带来的问题？"><span class="toc_mobile_items-number">1.1.1.</span> <span class="toc_mobile_items-text">a优化可能带来的问题？</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#b优化的需求？"><span class="toc_mobile_items-number">1.1.2.</span> <span class="toc_mobile_items-text">b优化的需求？</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2、优化思路"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">2、优化思路</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#a优化什么？"><span class="toc_mobile_items-number">1.2.1.</span> <span class="toc_mobile_items-text">a优化什么？</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#b优化的范围有哪些？"><span class="toc_mobile_items-number">1.2.2.</span> <span class="toc_mobile_items-text">b优化的范围有哪些？</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#c优化维度？"><span class="toc_mobile_items-number">1.2.3.</span> <span class="toc_mobile_items-text">c优化维度？</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#1、优化工具有啥？"><span class="toc_mobile_items-number">1.3.</span> <span class="toc_mobile_items-text">1、优化工具有啥？</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#a数据库层面？"><span class="toc_mobile_items-number">1.3.1.</span> <span class="toc_mobile_items-text">a数据库层面？</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#b数据库层面问题解决思路？"><span class="toc_mobile_items-number">1.3.2.</span> <span class="toc_mobile_items-text">b数据库层面问题解决思路？</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#c系统层面？"><span class="toc_mobile_items-number">1.3.3.</span> <span class="toc_mobile_items-text">c系统层面？</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#d系统层面问题解决办法？"><span class="toc_mobile_items-number">1.3.4.</span> <span class="toc_mobile_items-text">d系统层面问题解决办法？</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4、基础优化"><span class="toc_mobile_items-number">1.4.</span> <span class="toc_mobile_items-text">4、基础优化</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#a优化思路？"><span class="toc_mobile_items-number">1.4.1.</span> <span class="toc_mobile_items-text">a优化思路？</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#b硬件优化？"><span class="toc_mobile_items-number">1.4.2.</span> <span class="toc_mobile_items-text">b硬件优化？</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#c服务器硬件优化？"><span class="toc_mobile_items-number">1.4.3.</span> <span class="toc_mobile_items-text">c服务器硬件优化？</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#d系统优化？"><span class="toc_mobile_items-number">1.4.4.</span> <span class="toc_mobile_items-text">d系统优化？</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#e系统参数调整？"><span class="toc_mobile_items-number">1.4.5.</span> <span class="toc_mobile_items-text">e系统参数调整？</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#f应用优化？"><span class="toc_mobile_items-number">1.4.6.</span> <span class="toc_mobile_items-text">f应用优化？</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5、数据库优化"><span class="toc_mobile_items-number">1.5.</span> <span class="toc_mobile_items-text">5、数据库优化</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#a数据库参数优化？"><span class="toc_mobile_items-number">1.5.1.</span> <span class="toc_mobile_items-text">a数据库参数优化？</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#b存储引擎层（innodb基础优化参数）？"><span class="toc_mobile_items-number">1.5.2.</span> <span class="toc_mobile_items-text">b存储引擎层（innodb基础优化参数）？</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#史上最全SQL优化方案"><span class="toc-number">1.</span> <span class="toc-text">史上最全SQL优化方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、优化的哲学"><span class="toc-number">1.1.</span> <span class="toc-text">1、优化的哲学</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#a优化可能带来的问题？"><span class="toc-number">1.1.1.</span> <span class="toc-text">a优化可能带来的问题？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#b优化的需求？"><span class="toc-number">1.1.2.</span> <span class="toc-text">b优化的需求？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、优化思路"><span class="toc-number">1.2.</span> <span class="toc-text">2、优化思路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#a优化什么？"><span class="toc-number">1.2.1.</span> <span class="toc-text">a优化什么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#b优化的范围有哪些？"><span class="toc-number">1.2.2.</span> <span class="toc-text">b优化的范围有哪些？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#c优化维度？"><span class="toc-number">1.2.3.</span> <span class="toc-text">c优化维度？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1、优化工具有啥？"><span class="toc-number">1.3.</span> <span class="toc-text">1、优化工具有啥？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#a数据库层面？"><span class="toc-number">1.3.1.</span> <span class="toc-text">a数据库层面？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#b数据库层面问题解决思路？"><span class="toc-number">1.3.2.</span> <span class="toc-text">b数据库层面问题解决思路？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#c系统层面？"><span class="toc-number">1.3.3.</span> <span class="toc-text">c系统层面？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#d系统层面问题解决办法？"><span class="toc-number">1.3.4.</span> <span class="toc-text">d系统层面问题解决办法？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4、基础优化"><span class="toc-number">1.4.</span> <span class="toc-text">4、基础优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#a优化思路？"><span class="toc-number">1.4.1.</span> <span class="toc-text">a优化思路？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#b硬件优化？"><span class="toc-number">1.4.2.</span> <span class="toc-text">b硬件优化？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#c服务器硬件优化？"><span class="toc-number">1.4.3.</span> <span class="toc-text">c服务器硬件优化？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#d系统优化？"><span class="toc-number">1.4.4.</span> <span class="toc-text">d系统优化？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#e系统参数调整？"><span class="toc-number">1.4.5.</span> <span class="toc-text">e系统参数调整？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#f应用优化？"><span class="toc-number">1.4.6.</span> <span class="toc-text">f应用优化？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5、数据库优化"><span class="toc-number">1.5.</span> <span class="toc-text">5、数据库优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#a数据库参数优化？"><span class="toc-number">1.5.1.</span> <span class="toc-text">a数据库参数优化？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#b存储引擎层（innodb基础优化参数）？"><span class="toc-number">1.5.2.</span> <span class="toc-text">b存储引擎层（innodb基础优化参数）？</span></a></li></ol></li></ol></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://s1.ax1x.com/2020/03/16/8J7MAx.png)"><div id="post-info"><div id="post-title"><div class="posttitle">MySQL史上最全SQL优化方案</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2019-01-30<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2020-02-26</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon fa-fw" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">3.8k</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon fa-fw" aria-hidden="true"></i><span>阅读时长: 12 分钟</span><div class="post-meta-pv-cv"><span class="post-meta__separator">|</span><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span><span class="post-meta__separator">|</span><i class="fa fa-comments-o post-meta__icon fa-fw" aria-hidden="true"></i><span>评论数:</span><a href="/2019/01/30/MySQL%E5%8F%B2%E4%B8%8A%E6%9C%80%E5%85%A8SQL%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/2019/01/30/MySQL%E5%8F%B2%E4%B8%8A%E6%9C%80%E5%85%A8SQL%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88/" itemprop="commentCount"></span></a></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head></head><body><h1 id="史上最全SQL优化方案"><a href="#史上最全SQL优化方案" class="headerlink" title="史上最全SQL优化方案"></a>史上最全SQL优化方案</h1><p>在进行MySQL的优化之前，必须要了解的就是MySQL的查询过程，很多查询优化工作实际上就是遵循一些原则，让MySQL的优化器能够按照预想的合理方式运行而已。<br><a href="https://i.imgur.com/2q4bunY.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://i.imgur.com/2q4bunY.png" class="lazyload"></a></p>
<h2 id="1、优化的哲学"><a href="#1、优化的哲学" class="headerlink" title="1、优化的哲学"></a>1、优化的哲学</h2><p>注：优化有风险，涉足需谨慎</p>
<h3 id="a优化可能带来的问题？"><a href="#a优化可能带来的问题？" class="headerlink" title="a优化可能带来的问题？"></a>a优化可能带来的问题？</h3><ul>
<li><p>优化不总是对一个单纯的环境进行，还很可能是一个复杂的已投产的系统；</p>
</li>
<li><p>优化手段本来就有很大的风险，只不过你没能力意识到和预见到；</p>
</li>
<li><p>任何的技术可以解决一个问题，但必然存在带来一个问题的风险；</p>
</li>
<li><p>对于优化来说解决问题而带来的问题，控制在可接受的范围内才是有成果；</p>
</li>
<li><p>保持现状或出现更差的情况都是失败！</p>
</li>
</ul>
<h3 id="b优化的需求？"><a href="#b优化的需求？" class="headerlink" title="b优化的需求？"></a>b优化的需求？</h3><ul>
<li><p>稳定性和业务可持续性，通常比性能更重要；</p>
</li>
<li><p>优化不可避免涉及到变更，变更就有风险；</p>
</li>
<li><p>优化使性能变好，维持和变差是等概率事件；</p>
</li>
<li><p>切记优化，应该是各部门协同，共同参与的工作，任何单一部门都不能对数据库进行优化！</p>
</li>
</ul>
<p>所以优化工作，是由业务需要驱使的！</p>
<h2 id="2、优化思路"><a href="#2、优化思路" class="headerlink" title="2、优化思路"></a>2、优化思路</h2><h3 id="a优化什么？"><a href="#a优化什么？" class="headerlink" title="a优化什么？"></a>a优化什么？</h3><p>在数据库优化上有两个主要方面：即安全与性能。</p>
<ul>
<li><p>安全->数据可持续性；</p>
</li>
<li><p>性能->数据的高性能访问。</p>
</li>
</ul>
<h3 id="b优化的范围有哪些？"><a href="#b优化的范围有哪些？" class="headerlink" title="b优化的范围有哪些？"></a>b优化的范围有哪些？</h3><p><strong>存储、主机和操作系统方面：</strong></p>
<ul>
<li><p>主机架构稳定性；</p>
</li>
<li><p>I/O规划及配置；</p>
</li>
<li><p>Swap交换分区；</p>
</li>
<li><p>OS内核参数和网络问题。</p>
</li>
</ul>
<p><strong>应用程序方面：</strong></p>
<ul>
<li><p>应用程序稳定性；</p>
</li>
<li><p>SQL语句性能；</p>
</li>
<li><p>串行访问资源；</p>
</li>
<li><p>性能欠佳会话管理；</p>
</li>
<li><p>这个应用适不适合用MySQL。</p>
</li>
</ul>
<p><strong>数据库优化方面：</strong></p>
<ul>
<li><p>内存；</p>
</li>
<li><p>数据库结构（物理&逻辑）；</p>
</li>
<li><p>实例配置。</p>
</li>
</ul>
<p>说明：不管是设计系统、定位问题还是优化，都可以按照这个顺序执行。</p>
<h3 id="c优化维度？"><a href="#c优化维度？" class="headerlink" title="c优化维度？"></a>c优化维度？</h3><p><strong>数据库优化维度有四个：</strong><br>硬件、系统配置、数据库表结构、SQL及索引。<br><a href="https://i.imgur.com/UkvYZ6t.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://i.imgur.com/UkvYZ6t.png" class="lazyload"></a></p>
<p><strong>优化选择：</strong></p>
<ul>
<li><p>优化成本：硬件>系统配置>数据库表结构>SQL及索引。</p>
</li>
<li><p>优化效果：硬件<系统配置<数据库表结构<sql及索引。< p>
</sql及索引。<></p></li>
</ul>
<h2 id="1、优化工具有啥？"><a href="#1、优化工具有啥？" class="headerlink" title="1、优化工具有啥？"></a>1、优化工具有啥？</h2><h3 id="a数据库层面？"><a href="#a数据库层面？" class="headerlink" title="a数据库层面？"></a>a数据库层面？</h3><p>检查问题常用工具：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">1）MySQL</span><br><span class="line"></span><br><span class="line">2）msyqladmin：MySQL客户端，可进行管理操作</span><br><span class="line"></span><br><span class="line">3）mysqlshow：功能强大的查看shell命令</span><br><span class="line"></span><br><span class="line">4）show [SESSION | GLOBAL] variables：查看数据库参数信息</span><br><span class="line"></span><br><span class="line">5）SHOW [SESSION | GLOBAL] STATUS：查看数据库的状态信息</span><br><span class="line"></span><br><span class="line">6）information_schema：获取元数据的方法</span><br><span class="line"></span><br><span class="line">7）SHOW ENGINE INNODB STATUS：Innodb引擎的所有状态</span><br><span class="line"></span><br><span class="line">8）SHOW PROCESSLIST：查看当前所有连接session状态</span><br><span class="line"></span><br><span class="line">9）explain：获取查询语句的执行计划</span><br><span class="line"></span><br><span class="line">10）show index：查看表的索引信息</span><br><span class="line"></span><br><span class="line">11）slow-log：记录慢查询语句</span><br><span class="line"></span><br><span class="line">12）mysqldumpslow：分析slowlog文件的</span><br></pre></td></tr></tbody></table></figure></div>
<p>不常用但好用的工具：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1）Zabbix：监控主机、系统、数据库（部署zabbix监控平台）</span><br><span class="line"></span><br><span class="line">2）pt-query-digest：分析慢日志</span><br><span class="line"></span><br><span class="line">3）MySQL slap：分析慢日志</span><br><span class="line"></span><br><span class="line">4）sysbench：压力测试工具</span><br><span class="line"></span><br><span class="line">5）MySQL profiling：统计数据库整体状态工具    </span><br><span class="line"></span><br><span class="line">6）Performance Schema：MySQL性能状态统计的数据</span><br><span class="line"></span><br><span class="line">7）workbench：管理、备份、监控、分析、优化工具（比较费资源）</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="b数据库层面问题解决思路？"><a href="#b数据库层面问题解决思路？" class="headerlink" title="b数据库层面问题解决思路？"></a>b数据库层面问题解决思路？</h3><p>一般应急调优的思路：针对突然的业务办理卡顿，无法进行正常的业务处理，需要立马解决的场景。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1）show processlist；</span><br><span class="line"></span><br><span class="line">2）explain  select id ,name from stu where name='clsn'; # ALL  id name age  sex；</span><br><span class="line"></span><br><span class="line">select id,name from stu  where id=2-1 函数 结果集>30；show index from table；</span><br><span class="line"></span><br><span class="line">3）通过执行计划判断，索引问题（有没有、合不合理）或者语句本身问题；</span><br><span class="line"></span><br><span class="line">4）show status  like '%lock%';    # 查询锁状态</span><br><span class="line"></span><br><span class="line">kill SESSION_ID;   # 杀掉有问题的session。</span><br></pre></td></tr></tbody></table></figure></div>

<p>常规调优思路：针对业务周期性的卡顿，例如在每天10-11点业务特别慢，但是还能够使用，过了这段时间就好了。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1）查看slowlog，分析slowlog，分析出查询慢的语句；</span><br><span class="line"></span><br><span class="line">2）按照一定优先级，一个一个排查所有慢语句；</span><br><span class="line"></span><br><span class="line">3）分析top SQL，进行explain调试，查看语句执行时间；</span><br><span class="line"></span><br><span class="line">4）调整索引或语句本身。</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="c系统层面？"><a href="#c系统层面？" class="headerlink" title="c系统层面？"></a>c系统层面？</h3><p><strong>Cpu方面：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmstat、sar top、htop、nmon、mpstat；</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>内存：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free、ps-aux；</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>IO设备（磁盘、网络）：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iostat、ss、netstat、iptraf、iftop、lsof；</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>vmstat命令说明：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1）Procs：r显示有多少进程正在等待CPU时间。b显示处于不可中断的休眠的进程数量。在等待I/O。</span><br><span class="line"></span><br><span class="line">2）Memory：swpd显示被交换到磁盘的数据块的数量。未被使用的数据块，用户缓冲数据块，用于操作系统的数据块的数量。</span><br><span class="line"></span><br><span class="line">3）Swap：操作系统每秒从磁盘上交换到内存和从内存交换到磁盘的数据块的数量。s1和s0最好是0。</span><br><span class="line"></span><br><span class="line">4）Io：每秒从设备中读入b1的写入到设备b0的数据块的数量。反映了磁盘I/O。</span><br><span class="line"></span><br><span class="line">5）System：显示了每秒发生中断的数量（in）和上下文交换（cs）的数量。</span><br><span class="line"></span><br><span class="line">6）Cpu：显示用于运行用户代码，系统代码，空闲，等待I/O的Cpu时间。</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>iostat命令说明：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">实例命令：iostat -dk 1 5</span><br><span class="line"></span><br><span class="line">　　　　   iostat -d -k -x 5 （查看设备使用率（%util）和响应时间（await））</span><br><span class="line"></span><br><span class="line">1）tps：该设备每秒的传输次数。“一次传输”意思是“一次I/O请求”。多个逻辑请求可能会被合并为“一次I/O请求”。</span><br><span class="line"></span><br><span class="line">2）iops ：硬件出厂的时候，厂家定义的一个每秒最大的IO次数</span><br><span class="line"></span><br><span class="line">3）"一次传输"请求的大小是未知的。</span><br><span class="line"></span><br><span class="line">4）kB_read/s：每秒从设备（drive expressed）读取的数据量；</span><br><span class="line"></span><br><span class="line">5）KB_wrtn/s：每秒向设备（drive expressed）写入的数据量；</span><br><span class="line"></span><br><span class="line">6）kB_read：读取的总数据量；</span><br><span class="line"></span><br><span class="line">7）kB_wrtn：写入的总数量数据量；这些单位都为Kilobytes。</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="d系统层面问题解决办法？"><a href="#d系统层面问题解决办法？" class="headerlink" title="d系统层面问题解决办法？"></a>d系统层面问题解决办法？</h3><p>你认为到底负载高好，还是低好呢？在实际的生产中，一般认为Cpu只要不超过90%都没什么问题。<br>当然不排除下面这些特殊情况：<br><strong>Cpu负载高，IO负载低：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1）内存不够；</span><br><span class="line"></span><br><span class="line">2）磁盘性能差；</span><br><span class="line"></span><br><span class="line">3）SQL问题--->去数据库层，进一步排查SQL 问题；</span><br><span class="line"></span><br><span class="line">4）IO出问题了（磁盘到临界了、raid设计不好、raid降级、锁、在单位时间内tps过高）；</span><br><span class="line"></span><br><span class="line">5）tps过高：大量的小数据IO、大量的全表扫描。</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>IO负载高，Cpu负载低：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1）大量小的IO写操作：</span><br><span class="line"></span><br><span class="line">autocommit，产生大量小IO；IO/PS，磁盘的一个定值，硬件出厂的时候，厂家定义的一个每秒最大的IO次数。</span><br><span class="line"></span><br><span class="line">2）大量大的IO 写操作：SQL问题的几率比较大</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>IO和cpu负载都很高：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">硬件不够了或SQL存在问题。</span><br></pre></td></tr></tbody></table></figure></div>

<h2 id="4、基础优化"><a href="#4、基础优化" class="headerlink" title="4、基础优化"></a>4、基础优化</h2><h3 id="a优化思路？"><a href="#a优化思路？" class="headerlink" title="a优化思路？"></a>a优化思路？</h3><p><strong>定位问题点吮吸：</strong>硬件–>系统–>应用–>数据库–>架构（高可用、读写分离、分库分表）。</p>
<p><strong>处理方向：</strong>明确优化目标、性能和安全的折中、防患未然。</p>
<h3 id="b硬件优化？"><a href="#b硬件优化？" class="headerlink" title="b硬件优化？"></a>b硬件优化？</h3><p><strong>主机方面：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">根据数据库类型，主机CPU选择、内存容量选择、磁盘选择：</span><br><span class="line"></span><br><span class="line">1）平衡内存和磁盘资源；</span><br><span class="line"></span><br><span class="line">2）随机的I/O和顺序的I/O；</span><br><span class="line"></span><br><span class="line">3）主机 RAID卡的BBU（Battery Backup Unit）关闭。</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>CPU的选择：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CPU的两个关键因素：核数、主频</span><br><span class="line"></span><br><span class="line">根据不同的业务类型进行选择：</span><br><span class="line"></span><br><span class="line">1）CPU密集型：计算比较多，OLTP - 主频很高的cpu、核数还要多</span><br><span class="line"></span><br><span class="line">2）IO密集型：查询比较，OLAP - 核数要多，主频不一定高的</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>内存的选择：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OLAP类型数据库，需要更多内存，和数据获取量级有关。</span><br><span class="line"></span><br><span class="line">OLTP类型数据一般内存是Cpu核心数量的2倍到4倍，没有最佳实践。</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>存储方面：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1）根据存储数据种类的不同，选择不同的存储设备；</span><br><span class="line"></span><br><span class="line">2）配置合理的RAID级别（raid5、raid10、热备盘）；</span><br><span class="line"></span><br><span class="line">3）对与操作系统来讲，不需要太特殊的选择，最好做好冗余（raid1）（ssd、sas、sata）。</span><br><span class="line"></span><br><span class="line">4）raid卡：</span><br><span class="line"></span><br><span class="line">       主机raid卡选择：</span><br><span class="line"></span><br><span class="line">           实现操作系统磁盘的冗余（raid1）；</span><br><span class="line"></span><br><span class="line">           平衡内存和磁盘资源；</span><br><span class="line"></span><br><span class="line">           随机的I/O和顺序的I/O；</span><br><span class="line"></span><br><span class="line">           主机raid卡的BBU（Battery Backup Unit）要关闭。</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>网络设备方面：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">使用流量支持更高的网络设备（交换机、路由器、网线、网卡、HBA卡）</span><br></pre></td></tr></tbody></table></figure></div>

<p>注意：以上这些规划应该在初始设计系统时就应该考虑好。</p>
<h3 id="c服务器硬件优化？"><a href="#c服务器硬件优化？" class="headerlink" title="c服务器硬件优化？"></a>c服务器硬件优化？</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1）物理状态灯</span><br><span class="line"></span><br><span class="line">2）自带管理设备：远程控制卡（FENCE设备：ipmi ilo idarc）、开关机、硬件监控。</span><br><span class="line"></span><br><span class="line">3）第三方的监控软件、设备（snmp、agent）对物理设施进行监控。</span><br><span class="line"></span><br><span class="line">4）存储设备：自带的监控平台。EMC2（hp收购了）、 日立（hds）、IBM低端OEM hds、高端存储是自己技术，华为存储。</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="d系统优化？"><a href="#d系统优化？" class="headerlink" title="d系统优化？"></a>d系统优化？</h3><p><strong>Cpu：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">基本不需要调整，在硬件选择方面下功夫即可。</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>内存：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">基本不需要调整，在硬件选择方面下功夫即可。</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>SWAP：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MySQL尽量避免使用swap。</span><br><span class="line"></span><br><span class="line">阿里云的服务器中默认swap为0。</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>IO ：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">raid、no lvm、ext4或xfs、ssd、IO调度策略。</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>Swap调整(不使用swap分区)</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/proc/sys/vm/swappiness的内容改成0（临时），/etc/sysctl. conf上添加vm.swappiness=0（永久）</span><br></pre></td></tr></tbody></table></figure></div>

<p>这个参数决定了Linux是倾向于使用swap，还是倾向于释放文件系统cache。在内存紧张的情况下，数值越低越倾向于释放文件系统cache。</p>
<p>当然，这个参数只能减少使用swap的概率，并不能避免Linux使用swap。</p>
<p><strong>修改MySQL的配置参数innodb_flush_ method，开启O_DIRECT模式：</strong><br>这种情况下，InnoDB的buffer pool会直接绕过文件系统cache来访问磁盘，但是redo log依旧会使用文件系统cache。<br>值得注意的是，Redo log是覆写模式的，即使使用了文件系统的cache，也不会占用太多。</p>
<p><strong>IO调度策略：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#echo deadline>/sys/block/sda/queue/scheduler   临时修改为deadline</span><br></pre></td></tr></tbody></table></figure></div>

<p>永久修改</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /boot/grub/grub.conf</span><br><span class="line">更改到如下内容:</span><br><span class="line">kernel /boot/vmlinuz-2.6.18-8.el5 ro root=LABEL=/ elevator=deadline rhgb quiet</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="e系统参数调整？"><a href="#e系统参数调整？" class="headerlink" title="e系统参数调整？"></a>e系统参数调整？</h3><p><strong>Linux系统内核参数优化：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim/etc/sysctl.conf</span><br><span class="line"></span><br><span class="line">net.ipv4.ip_local_port_range = 1024 65535：# 用户端口范围</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 4096 </span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_fin_timeout = 30 </span><br><span class="line"></span><br><span class="line">fs.file-max=65535：# 系统最大文件句柄，控制的是能打开文件最大数量</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>用户限制参数（MySQL可以不设置以下配置）：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim/etc/security/limits.conf </span><br><span class="line"></span><br><span class="line">* soft nproc 65535</span><br><span class="line"></span><br><span class="line">* hard nproc 65535</span><br><span class="line"></span><br><span class="line">* soft nofile 65535</span><br><span class="line"></span><br><span class="line">* hard nofile 65535</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="f应用优化？"><a href="#f应用优化？" class="headerlink" title="f应用优化？"></a>f应用优化？</h3><p>业务应用和数据库应用独立；<br><strong>防火墙：</strong>iptables、selinux等其他无用服务（关闭）：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --level 23456 acpid off</span><br><span class="line"></span><br><span class="line">chkconfig --level 23456 anacron off</span><br><span class="line"></span><br><span class="line">chkconfig --level 23456 autofs off</span><br><span class="line"></span><br><span class="line">chkconfig --level 23456 avahi-daemon off</span><br><span class="line"></span><br><span class="line">chkconfig --level 23456 bluetooth off</span><br><span class="line"></span><br><span class="line">chkconfig --level 23456 cups off</span><br><span class="line"></span><br><span class="line">chkconfig --level 23456 firstboot off</span><br><span class="line"></span><br><span class="line">chkconfig --level 23456 haldaemon off</span><br><span class="line"></span><br><span class="line">chkconfig --level 23456 hplip off</span><br><span class="line"></span><br><span class="line">chkconfig --level 23456 ip6tables off</span><br><span class="line"></span><br><span class="line">chkconfig --level 23456 iptables  off</span><br><span class="line"></span><br><span class="line">chkconfig --level 23456 isdn off</span><br><span class="line"></span><br><span class="line">chkconfig --level 23456 pcscd off</span><br><span class="line"></span><br><span class="line">chkconfig --level 23456 sendmail  off</span><br><span class="line"></span><br><span class="line">chkconfig --level 23456 yum-updatesd  off</span><br></pre></td></tr></tbody></table></figure></div>

<p>安装图形界面的服务器不要启动图形界面runlevel 3。<br>另外，思考将来我们的业务是否真的需要MySQL，还是使用其他种类的数据库。用数据库的最高境界就是不用数据库。</p>
<h2 id="5、数据库优化"><a href="#5、数据库优化" class="headerlink" title="5、数据库优化"></a>5、数据库优化</h2><p><strong>SQL优化方向：</strong>执行计划、索引、SQL改写。<br><strong>架构优化方向：</strong>高可用架构、高性能架构、分库分表。</p>
<h3 id="a数据库参数优化？"><a href="#a数据库参数优化？" class="headerlink" title="a数据库参数优化？"></a>a数据库参数优化？</h3><p><strong>调整</strong><br>实例整体（高级优化，扩展）：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">thread_concurrency：# 并发线程数量个数</span><br><span class="line"></span><br><span class="line">sort_buffer_size：# 排序缓存</span><br><span class="line"></span><br><span class="line">read_buffer_size：# 顺序读取缓存</span><br><span class="line"></span><br><span class="line">read_rnd_buffer_size：# 随机读取缓存</span><br><span class="line"></span><br><span class="line">key_buffer_size：# 索引缓存</span><br><span class="line"></span><br><span class="line">thread_cache_size：# (1G—>8, 2G—>16, 3G—>32, >3G—>64)</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>连接层（基础优化）</strong><br>设置合理的连接客户和连接方式：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">max_connections           # 最大连接数，看交易笔数设置    </span><br><span class="line"></span><br><span class="line">max_connect_errors        # 最大错误连接数，能大则大</span><br><span class="line"></span><br><span class="line">connect_timeout           # 连接超时</span><br><span class="line"></span><br><span class="line">max_user_connections      # 最大用户连接数</span><br><span class="line"></span><br><span class="line">skip-name-resolve         # 跳过域名解析</span><br><span class="line"></span><br><span class="line">wait_timeout              # 等待超时</span><br><span class="line"></span><br><span class="line">back_log                  # 可以在堆栈中的连接数量</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>SQL层（基础优化）</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">query_cache_size： 查询缓存  >>>  OLAP类型数据库,需要重点加大此内存缓存，但是一般不会超过GB。</span><br><span class="line"></span><br><span class="line">对于经常被修改的数据，缓存会立马失效。</span><br><span class="line"></span><br><span class="line">我们可以实用内存数据库（redis、memecache），替代他的功能。</span><br></pre></td></tr></tbody></table></figure></div>

<h3 id="b存储引擎层（innodb基础优化参数）？"><a href="#b存储引擎层（innodb基础优化参数）？" class="headerlink" title="b存储引擎层（innodb基础优化参数）？"></a>b存储引擎层（innodb基础优化参数）？</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">default-storage-engine</span><br><span class="line"></span><br><span class="line">innodb_buffer_pool_size       # 没有固定大小，50%测试值，看看情况再微调。但是尽量设置不要超过物理内存70%</span><br><span class="line"></span><br><span class="line">innodb_file_per_table=(1,0)</span><br><span class="line"></span><br><span class="line">innodb_flush_log_at_trx_commit=(0,1,2) # 1是最安全的，0是性能最高，2折中</span><br><span class="line"></span><br><span class="line">binlog_sync</span><br><span class="line"></span><br><span class="line">Innodb_flush_method=(O_DIRECT, fdatasync)</span><br><span class="line"></span><br><span class="line">innodb_log_buffer_size           # 100M以下</span><br><span class="line"></span><br><span class="line">innodb_log_file_size               # 100M 以下</span><br><span class="line"></span><br><span class="line">innodb_log_files_in_group       # 5个成员以下,一般2-3个够用（iblogfile0-N）</span><br><span class="line"></span><br><span class="line">innodb_max_dirty_pages_pct   # 达到百分之75的时候刷写 内存脏页到磁盘。</span><br><span class="line"></span><br><span class="line">log_bin</span><br><span class="line"></span><br><span class="line">max_binlog_cache_size                     # 可以不设置</span><br><span class="line"></span><br><span class="line">max_binlog_size                               # 可以不设置</span><br><span class="line"></span><br><span class="line">innodb_additional_mem_pool_size     #小于2G内存的机器，推荐值是20M。32G内存以上100M</span><br></pre></td></tr></tbody></table></figure></div>

<p>谈谈项目中常用的MySQL优化方法，共19条，具体如下：<br><strong>1、EXPLAIN</strong><br>做MySQL优化，我们要善用EXPLAIN查看SQL执行计划。</p>
<p>下面来个简单的示例，标注（1、2、3、4、5）我们要重点关注的数据：</p>
<p><a href="https://i.imgur.com/TWfKAPb.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://i.imgur.com/TWfKAPb.png" class="lazyload"></a></p>
<p>type列，连接类型。一个好的SQL语句至少要达到range级别。杜绝出现all级别。<br>key列，使用到的索引名。如果没有选择索引，值是NULL。可以采取强制索引方式。<br>key_len列，索引长度。<br>rows列，扫描行数。该值是个预估值。<br>extra列，详细说明。注意，常见的不太友好的值，如下：Using filesort，Using temporary。</p>
<p><strong>2、SQL语句中IN包含的值不应过多</strong><br>MySQL对于IN做了相应的优化，即将IN中的常量全部存储在一个数组里面，而且这个数组是排好序的。但是如果数值较多，产生的消耗也是比较大的。再例如：select id from t where num in(1,2,3) 对于连续的数值，能用between就不要用in了；再或者使用连接来替换。</p>
<p><strong>3、SELECT语句务必指明字段名称</strong><br>SELECT*增加很多不必要的消耗（CPU、IO、内存、网络带宽）；增加了使用覆盖索引的可能性；当表结构发生改变时，前断也需要更新。所以要求直接在select后面接上字段名。</p>
<p><strong>4、当只需要一条数据的时候，使用limit 1</strong><br>这是为了使EXPLAIN中type列达到const类型</p>
<p><strong>5、如果排序字段没有用到索引，就尽量少排序</strong></p>
<p><strong>6、如果限制条件中其他字段没有索引，尽量少用or</strong><br>or两边的字段中，如果有一个不是索引字段，而其他条件也不是索引字段，会造成该查询不走索引的情况。很多时候使用union all或者是union（必要的时候）的方式来代替“or”会得到更好的效果。</p>
<p><strong>7、尽量用union all代替union</strong><br>union和union all的差异主要是前者需要将结果集合并后再进行唯一性过滤操作，这就会涉及到排序，增加大量的CPU运算，加大资源消耗及延迟。当然，union all的前提条件是两个结果集没有重复数据。</p>
<p><strong>8、不使用ORDER BY RAND()</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> <span class="string">`dynamic`</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">rand</span>() <span class="keyword">limit</span> <span class="number">1000</span>;</span><br></pre></td></tr></tbody></table></figure></div>
<p>上面的SQL语句，可优化为：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> <span class="string">`dynamic`</span> t1 <span class="keyword">join</span> (<span class="keyword">select</span> <span class="keyword">rand</span>() * (<span class="keyword">select</span> <span class="keyword">max</span>(<span class="keyword">id</span>) <span class="keyword">from</span> <span class="string">`dynamic`</span>) <span class="keyword">as</span> nid) t2 <span class="keyword">on</span> t1.id > t2.nidlimit <span class="number">1000</span>;</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>9、区分in和exists、not in和not exists</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> 表A <span class="keyword">where</span> <span class="keyword">id</span> <span class="keyword">in</span> (<span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> 表B)</span><br></pre></td></tr></tbody></table></figure></div>
<p>上面SQL语句相当于</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> 表A <span class="keyword">where</span> <span class="keyword">exists</span>(<span class="keyword">select</span> * <span class="keyword">from</span> 表B <span class="keyword">where</span> 表B.id=表A.id)</span><br></pre></td></tr></tbody></table></figure></div>

<p>区分in和exists主要是造成了驱动顺序的改变（这是性能变化的关键），如果是exists，那么以外层表为驱动表，先被访问，如果是IN，那么先执行子查询。所以IN适合于外表大而内表小的情况；EXISTS适合于外表小而内表大的情况。</p>
<p>关于not in和not exists，推荐使用not exists，不仅仅是效率问题，not in可能存在逻辑问题。如何高效的写出一个替代not exists的SQL语句？</p>
<p>原SQL语句：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> colname … <span class="keyword">from</span> A表 <span class="keyword">where</span> a.id <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">select</span> b.id <span class="keyword">from</span> B表)</span><br></pre></td></tr></tbody></table></figure></div>

<p>高效的SQL语句：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> colname … <span class="keyword">from</span> A表 <span class="keyword">Left</span> <span class="keyword">join</span> B表 <span class="keyword">on</span> <span class="keyword">where</span> a.id = b.id <span class="keyword">where</span> b.id <span class="keyword">is</span> <span class="literal">null</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>取出的结果集如下图表示，A表不在B表中的数据：<br><a href="https://i.imgur.com/FULvDCo.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://i.imgur.com/FULvDCo.png" class="lazyload"></a></p>
<p><strong>10、使用合理的分页方式以提高分页的效率</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">name</span> <span class="keyword">from</span> product <span class="keyword">limit</span> <span class="number">866613</span>, <span class="number">20</span></span><br></pre></td></tr></tbody></table></figure></div>

<p>使用上述SQL语句做分页的时候，可能有人会发现，随着表数据量的增加，直接使用limit分页查询会越来越慢。<br><strong>优化的方法如下：</strong><br>可以取前一页的最大行数的id，然后根据这个最大的id来限制下一页的起点。比如此列中，上一页最大的id是866612。<br><strong>SQL可以采用如下的写法：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">name</span> <span class="keyword">from</span> product <span class="keyword">where</span> <span class="keyword">id</span>> <span class="number">866612</span> <span class="keyword">limit</span> <span class="number">20</span></span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>11、分段查询</strong><br>在一些用户选择页面中，可能一些用户选择的时间范围过大，造成查询缓慢。主要的原因是扫描行数过多。这个时候可以通过程序，分段进行查询，循环遍历，将结果合并处理进行展示。</p>
<p>如下图这个SQL语句，扫描的行数成百万级以上的时候就可以使用分段查询：<br><a href="https://i.imgur.com/XDCI9bK.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://i.imgur.com/XDCI9bK.png" class="lazyload"></a></p>
<p><strong>12、避免在where子句中对字段进行null值判断</strong><br>对于null的判断会导致引擎放弃使用索引而进行全表扫描。</p>
<p><strong>13、不建议使用%前缀模糊查询</strong><br>例如LIKE“%name”或者LIKE“%name%”，这种查询会导致索引失效而进行全表扫描。但是可以使用LIKE “name%”。<br>那如何查询%name%？<br>如下图所示，虽然给secret字段添加了索引，但在explain结果并没有使用：<br><a href="https://i.imgur.com/E9YS8j4.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://i.imgur.com/E9YS8j4.png" class="lazyload"></a><br>那么如何解决这个问题呢，答案：使用全文索引。</p>
<p>在我们查询中经常会用到<strong>select id,fnum,fdst from dynamic_201606 where user_name like ‘%zhangsan%’;</strong> 。这样的语句，普通索引是无法满足查询需求的。庆幸的是在MySQL中，有全文索引来帮助我们。</p>
<p><strong>创建全文索引的SQL语法是：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`dynamic_201606`</span> <span class="keyword">ADD</span> FULLTEXT <span class="keyword">INDEX</span> <span class="string">`idx_user_name`</span> (<span class="string">`user_name`</span>);</span><br></pre></td></tr></tbody></table></figure></div>
<p><strong>使用全文索引的SQL语句是：</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,fnum,fdst <span class="keyword">from</span> dynamic_201606 <span class="keyword">where</span> <span class="keyword">match</span>(user_name) against(<span class="string">'zhangsan'</span> <span class="keyword">in</span> <span class="built_in">boolean</span> <span class="keyword">mode</span>);</span><br></pre></td></tr></tbody></table></figure></div>

<p>注意：在需要创建全文索引之前，请联系DBA确定能否创建。同时需要注意的是查询语句的写法与普通索引的区别。</p>
<p><strong>14、避免在where子句中对字段进行表达式操作</strong><br>比如：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> user_id,user_project <span class="keyword">from</span> user_base <span class="keyword">where</span> age*<span class="number">2</span>=<span class="number">36</span>;</span><br></pre></td></tr></tbody></table></figure></div>

<p>中对字段就行了算术运算，这会造成引擎放弃使用索引，建议改成：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> user_id,user_project <span class="keyword">from</span> user_base <span class="keyword">where</span> age=<span class="number">36</span>/<span class="number">2</span>;</span><br></pre></td></tr></tbody></table></figure></div>

<p><strong>15、避免隐式类型转换</strong><br>where子句中出现column字段的类型和传入的参数类型不一致的时候发生的类型转换，建议先确定where中的参数类型。</p>
<p><strong>16、对于联合索引来说，要遵守最左前缀法则</strong><br>举列来说索引含有字段id、name、school，可以直接用id字段，也可以id、name这样的顺序，但是name;school都无法使用这个索引。所以在创建联合索引的时候一定要注意索引字段顺序，常用的查询字段放在最前面。</p>
<p><strong>17、必要时可以使用force index来强制查询走某个索引</strong><br>有的时候MySQL优化器采取它认为合适的索引来检索SQL语句，但是可能它所采用的索引并不是我们想要的。这时就可以采用forceindex来强制优化器使用我们制定的索引。</p>
<p><strong>18、注意范围查询语句</strong><br>对于联合索引来说，如果存在范围查询，比如between、>、<等条件时，会造成后面的索引字段失效。</p>
<p><strong>19、关于JOIN优化</strong><br><a href="https://i.imgur.com/QOcz25x.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://i.imgur.com/QOcz25x.png" class="lazyload"></a></p>
<p>LEFT JOIN A表为驱动表，INNER JOIN MySQL会自动找出那个数据少的表作用驱动表，RIGHT JOIN B表为驱动表。</p>
<p><strong>注意：</strong><br>1）MySQL中没有full join，可以用以下方式来解决：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> A <span class="keyword">left</span> <span class="keyword">join</span> B <span class="keyword">on</span> B.name = A.namewhere B.name <span class="keyword">is</span> nullunion allselect * <span class="keyword">from</span> B;</span><br></pre></td></tr></tbody></table></figure></div>

<p>2）尽量使用inner join，避免left join：<br>参与联合查询的表至少为2张表，一般都存在大小之分。如果连接方式是inner join，在没有其他过滤条件的情况下MySQL会自动选择小表作为驱动表，但是left join在驱动表的选择上遵循的是左边驱动右边的原则，即left join左边的表名为驱动表。</p>
<p>3）合理利用索引：<br>被驱动表的索引字段作为on的限制字段。</p>
<p>4）利用小表去驱动大表：<br><a href="https://i.imgur.com/lYmzIyp.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://i.imgur.com/lYmzIyp.png" class="lazyload"></a></p>
<p>从原理图能够直观的看出如果能够减少驱动表的话，减少嵌套循环中的循环次数，以减少 IO总量及CPU运算的次数。</p>
<p>5）巧用STRAIGHT_JOIN：<br>inner join是由MySQL选择驱动表，但是有些特殊情况需要选择另个表作为驱动表，比如有group by、order by等「Using filesort」、「Using temporary」时。STRAIGHT_JOIN来强制连接顺序，在STRAIGHT_JOIN左边的表名就是驱动表，右边则是被驱动表。在使用STRAIGHT_JOIN有个前提条件是该查询是内连接，也就是inner join。其他链接不推荐使用STRAIGHT_JOIN，否则可能造成查询结果不准确。</p>
<p><a href="https://i.imgur.com/baYubFP.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://i.imgur.com/baYubFP.png" class="lazyload"></a></p>
<p>这个方式有时能减少3倍的时间。<br>以上19条MySQL优化方法希望对大家有所帮助！</p>
</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">一叶秋枫</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://hwy.ac.cn/2019/01/30/MySQL%E5%8F%B2%E4%B8%8A%E6%9C%80%E5%85%A8SQL%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88/">https://hwy.ac.cn/2019/01/30/MySQL%E5%8F%B2%E4%B8%8A%E6%9C%80%E5%85%A8SQL%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://hwy.ac.cn">一叶秋枫</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MySQL/">MySQL    </a></div><div class="post_share"><div class="social-share" data-image="https://s1.ax1x.com/2020/03/16/8J7MAx.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.png" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.png" alt="支付寶"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/02/18/nginx%E4%B9%8Bproxy_pass%E4%BB%A3%E7%90%86%E5%90%8E%E7%AB%AFhttps%E8%AF%B7%E6%B1%82%E5%AE%8C%E5%85%A8%E6%8B%86%E8%A7%A3/"><img class="prev_cover lazyload" data-src="https://s1.ax1x.com/2020/03/16/8J783D.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>nginx之proxy_pass代理后端https请求完全拆解</span></div></a></div><div class="next-post pull_right"><a href="/2019/01/29/go-fastdfs%20%E5%B0%8F%E5%B7%A7%E7%81%B5%E6%B4%BB%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/"><img class="next_cover lazyload" data-src="https://s1.ax1x.com/2020/03/16/8J7FhT.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>go-fastdfs 小巧灵活的文件系统</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/04/17/left join、right join和join，傻傻分不清？/" title="left join、right join和join，傻傻分不清？"><img class="relatedPosts_cover lazyload"data-src="https://s1.ax1x.com/2020/03/16/8J7MAx.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-17</div><div class="relatedPosts_title">left join、right join和join，傻傻分不清？</div></div></a></div><div class="relatedPosts_item"><a href="/2018/11/19/MySQL 基本语法/" title="MySQL 基本语法"><img class="relatedPosts_cover lazyload"data-src="https://s1.ax1x.com/2020/03/16/8J783D.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-11-19</div><div class="relatedPosts_title">MySQL 基本语法</div></div></a></div><div class="relatedPosts_item"><a href="/2018/07/27/Docker 安装mysql5.7/" title="Docker 安装mysql5.7"><img class="relatedPosts_cover lazyload"data-src="https://s1.ax1x.com/2020/03/16/8J7uH1.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-07-27</div><div class="relatedPosts_title">Docker 安装mysql5.7</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = false == true ? true : false;
var verify = false == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'z5BfPsXWcymDudP8Nc99LtRc-gzGzoHsz',
  appKey:'6jqeO18XzzYHJCR0n4hYYq6z',
  placeholder:'来都来了，不留下个脚印吗',
  avatar:'monsterid',
  guest_info:guest_info,
  pageSize:'10',
  lang:'zh-cn',
  recordIP: true
});</script></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By 一叶秋枫</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="icp"><a><img class="icp-icon" src="/img/icp.png"><span>粤ICP备17059405号-1</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script id="ribbon" src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/canvas-ribbon.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/js/click_heart.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>